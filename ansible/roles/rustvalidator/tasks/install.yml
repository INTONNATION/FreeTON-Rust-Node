---

environment:
  ELECTOR_ADDR: "{{ elector_addr }}"
  ELECTOR_ADDR_HEX: "{{ elector_addr_hex }}"
  MSIG_ADDR_HEX: "{{ msig_addr_hex}}"
  MSIG_ADDR: "{{ msig_addr}}"
  MSIG_ADDR_HEX_0: "{{ msig_addr_hex_0 }}"
  CONFIGS_DIR: "{{ rustvalidator_conf_dir }}"
  DEPOOL_ADDR: "{{ depool_addr }}"
  REMAINED_FOR_FEES: "{{ remained_for_fees }}"
  VALIDATOR: "{{ validator }}"
  ELECTOR_TYPE: "{{ elector_type }}"

- name: Create rustvalidator user
  user:
    name: rustvalidator
    create_home: no
    shell: /usr/sbin/nologin
    group: rust
  tags:
   - install
   - upgrade
   - reinstall

- name: Create config directory
  file:
    path: "{{ item }}"
    state: directory
    owner: rustvalidator
    mode: '0755'
  with_items:
    - "{{ rustvalidator_conf_dir }}"
  tags:
   - install
   - upgrade
   - reinstall

- name: Install requirements for package install
  package:
    name:
      - python3-pip
      - python3-virtualenv
      - python3-dev
      - virtualenv
    state: present
  tags:
    - install

- name: Install system packages required for pyenv
  package:
    name:
      - gcc
      - libbz2-dev
      - libreadline-dev
      - libssl-dev
      - libsqlite3-dev
      - make
      - zlib1g-dev
    state: present
  tags:
    - install

- name: "Copy requirements.txt"
  copy:
    src: 'requirements.txt'
    dest: '{{ rustvalidator_conf_dir }}'
  tags:
    - install

- name: Install specified python requirements in indicated
  shell : 'cd {{ rustvalidator_conf_dir }}; pip3 install -r requirements.txt'
  tags:
    - install

- name: Config tonos-cli
  shell : 'cd {{ rustvalidator_conf_dir }}; tonos-cli config --url {{ dapp_server_url }}'
  tags:
    - install

- name: setup tonoscli
  shell: "echo 'TONOSCLI_CONFIG="{{ rustvalidator_conf_dir }}/tonos-cli.conf.json"'

- name: Download {{ network }} abhi configs
  get_url:
    url: "{{ item.key }}"
    dest: "{{ rustvalidator_conf_dir }}/{{ item.value }}"
  with_items:
    - { "key": "{{ config_safemultisig_abi }}","value": "SafeMultisigWallet.abi.json" }
    - { "key": "{{ config_abi_elector_url }}","value": "Elector.abi.json" }
    - { "key": "{{ config_abi_depool_helper_url }}","value": "DePoolHelper.abi.json" }
  tags:
   - install
   - upgrade
   - reinstall

- name: Template systemd service
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  with_items:
    - {"src": "rustvalidator.service.j2", "dest": "/etc/systemd/system/rustvalidator.service"}
  tags:
   - install
   - upgrade
   - reinstall
